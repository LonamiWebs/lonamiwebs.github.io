<!DOCTYPE html>
<html>
<head>
    <title>Installing NixOS, Take 2</title>
    <link rel="stylesheet" type="text/css" href="styles/main.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div class="minMargin">
    <div class="card">
        <h1>Installing NixOS, Take 2</h1>
        <p class="right"><em>Written by
        <a href="https://lonamiwebs.github.io">Imanol H.</a><br />
        the 15-02-2019. Last revision the 15-02-2019</em></p>
        <hr />
        <p>This is my second take at installing NixOS, after
        a while being frustrated with Arch Linux and the fact
        that a few kernel upgrades ago, the system crashed
        randomly from time to time. <code>journalctl</code>
        did not have any helpful hints and I thought reinstalling
        could be worthwhile anyway.</p>

        <p>This time, I started with more knowledge! The first step
        is heading to the <a href="https://nixos.org">NixOS website</a>
        and downloading their minimal installation CD for 64 bits.
        I didn't go with their graphical live CD, because their
        <a href="https://nixos.org/nixos/manual">installation manual</a>
        is a wonderful resource that guides you nicely.</p>

        <p>Once you have downloaded their <code>.iso</code>, you
        should probably verify it's <code>sha256sum</code> and make
        sure that it matches. The easiest thing to do in my opinion
        is using an USB to burn the image in it. Plug it in and check
        its device name with <code>fdisk -l</code>. In my case, it
        was <code>/dev/sdb</code>, so I went ahead with it and ran
        <code>dd if=nixos.iso of=/dev/sdb status=progress</code>.
        Make sure to run <code>sync</code> once that's done.</p>

        <p>If either <code>dd</code> or <code>sync</code> seem
        "stuck" in the end, they are just flushing the changes
        to disk to make sure all is good. This is normal, and
        depends on your drives.</p>

        <p>Now, reboot your computer with the USB plugged in
        and make sure to boot into it. You should be welcome
        with a pretty screen. Just select the first option and
        wait until it logs you in as root. Once you're there
        you probably want to <code>loadkeys es</code> or whatever
        your keyboard layout is, or you will have a hard time with
        passwords, since the characters are all over the place.</p>

        <p>In a clean disk, you would normally create the partitions
        now. In my case, I already had the partitions made (100MB for
        the EFI system, where <code>/boot</code> lives, 40GB for the
        root <code>/</code> partition with my old Linux installation,
        and 700G for <code>/home</code>), so I didn't need to do anything
        here. The manual showcases <code>parted</code>, but I personally
        use <code>fdisk</code>, which has very helpful help I check every
        time I use it.</p>

        <p><strong>Important</strong>: The <code>XY</code> in
        <code>/dev/sdXY</code> is probably different in your system!
        Make sure you use <code>fdisk -l</code> to see the correct
        letters and numbers!</p>

        <p>With the partitions ready in my UEFI system, I formatted both
        <code>/</code> and <code>/boot</code> just to be safe with
        <code>mkfs.ext4 -L nixos /dev/sda2</code> and
        <code>mkfs.fat -F 32 -n boot /dev/sda1</code> (remember that
        these are the letters and numbers used in my partition scheme).
        Don't worry about the warning in the second command regarding
        lowercase letters and Windows. It's not really an issue.</p>

        <p>Now, since we gave each partition a label, we can easily
        mount them through <code>mount /dev/disk/by-label/nixos /mnt</code>
        and, in UEFI systems, be sure to <code>mkdir -p /mnt/boot</code>
        and <code>mount /dev/disk/by-label/boot /mnt/boot</code>. I
        didn't bother setting up swap, since I have 8GB of RAM in my
        laptop and that's really enough for my use case.</p>

        <p>With that done, we will now ask the configuration wizard
        to do some work for us (in particular, generate a template) with
        <code>nixos-generate-config --root /mnt</code>. This generates
        a very well documented file that we should edit right now (and
        this is important!) with whatever editor you prefer. I used
        <code>vim</code>, but you can change it for <code>nano</code>
        if you prefer.</p>

        <p>On to the configuration file, we need to enable a few things,
        so <code>vim /mnt/etc/nixos/configuration.nix</code> and start
        scrolling down. We want to make sure to uncomment:</p>

<pre># We really want network!
networking.wireless.enable = true;

# This "fixes" the keyboard layout. Put the one you use.
i18n = {
  consoleKeyMap = "es";
}

# Timezones are tricky so let's get this right.
time.timeZone = "Europe/Madrid";

# We *really* want some base packages installed, such as
# wpa_supplicant, or we won't have a way to connect to the
# network once we install...
environment.systemPackages = with pkgs; [
  wpa_supplicant wget curl vim neovim cmus mpv firefox git tdesktop
];

# Printing is useful, sure, enable CUPS
services.printing.enable = true;

# We have speakers, let's make use of them.
sound.enable = true;
hardware.pulseaudio.enable = true;

# We want the X11 windowing system enabled, in Spanish.
services.xserver.enable = true;
services.xserver.layout = "es";

# I want a desktop manager in my laptop.
# I personally prefer XFCE, but the manual shows plenty
# of other options, such as Plasma, i3 WM, or whatever.
services.xserver.desktopManager.xfce.enable = true;
services.xserver.desktopManager.default = "xfce";

# Touchpad is useful (although sometimes annoying) in a laptop
services.xserver.libinput.enable = true;

# We don't want to do everything as root!
users.users.lonami = {
  isNormalUser = true;
  uid = 1000;
  home = "/home/lonami";
  extraGroups = [ "wheel" "networkmanager" "audio" ];
};
</pre>

        <p><em>(Fun fact, I overlooked the configuration file until
        I wrote this and hadn't noticed sound/pulseaudio was there.
        It wasn't hard to find online how to enable it though!)</em></p>

        <p>Now, let's modify <code>hardware-configuration.nix</code>.
        But if you have <code>/home</code> in a separate partition
        like me, you should run <code>blkid</code> to figure out
        its UUID. To avoid typing it out myself, I just ran
        <code>blkid &gt;&gt; /mnt/etc/nixos/hardware-configuration.nix</code>
        so that I could easily move it around with <code>vim</code>:</p>

<pre># (stuff...)

fileSystems."/home" =
  { device = "/dev/disk/by-uuid/d344c686-cae7-4dd3-840e-308eddf86608";
    fsType = "ext4";
  };

# (more stuff...)
</pre>

        <p>Note that, obviously, you should put your own partition's
        UUID there. Modifying the configuration is where I think the
        current NixOS' manual should have made more emphasis, at this
        step of the installation. They do detail it below, but that
        was already too late in my first attempt. Anyway, you can boot
        from the USB and run <code>nixos-install</code> as many times
        as you need until you get it working!</p>

        <p>But before installing, we need to configure the network
        since there are plenty of things to download. If you want to
        work from WiFi, you should first figure out the name of your
        network card with <code>ip link show</code>. In my case it's
        called <code>wlp3s0</code>. So with that knowledge we can run
        <code>wpa_supplicant -B -i wlp3s0 -c
        &lt;(wpa_passphrase SSID key)</code>. Be sure to replace both
        <code>SSID</code> and <code>key</code> with the name of your
        network and password key, respectively. If they have spaces,
        surround them in quotes.</p>

        <p>Another funny pitfall was typing <code>wpa_supplicant</code>
        in the command above twice (instead of <code>wpa_passphrase</code>).
        That sure spit out a few funny errors! Once you have ran that,
        wait a few seconds and <code>ping 1.1.1.1</code> to make sure
        that you can reach the internet. If you do, <code>^C</code> and
        let's install NixOS!</p>

<pre>nixos-install</pre>

        <p>Well, that was pretty painless. You can now <code>reboot</code>
        and enjoy your new, functional system.</p>

        <h2>Afterword</h2>

        <p>The process of installing NixOS was really painless once you
        have made sense out of what things mean. I was far more pleased
        this time than in my previous attempt, despite the four attempts
        I needed to have it up and running.</p>

        <p>However not all is so good. I'm not sure where I went wrong,
        but the first time I tried with <code>i3</code> instead of
        <code>xfce</code>, all I was welcome with was a white, small
        terminal in the top left corner. I even generated a configuration
        file with <code>i3-config-wizard</code> to make sure it could
        detect my Mod1/Mod4 keys (which, it did), but even after rebooting,
        my commands weren't responding. For example, I couldn't manage
        to open another terminal with <code>Mod1+Enter</code>. I'm not
        even sure that I was in <code>i3</code>…</p>

        <p>In my very first attempt, I pressed <code>Alt+F8</code> as
        suggested in the welcome message. This took me an offline copy
        of the manual, which is really nicely done. Funny enough, though,
        I couldn't exit <code>w3m</code>. Both <code>Q</code> and
        <code>B</code> to quit and take me back wouldn't work. Somehow,
        it kept throwing me back into <code>w3m</code>, so I had to
        forcibly shutdown.</p>

        <p>In my second attempt, I also forgot to configure network,
        so I had no way to download <code>wpa_supplicant</code> without
        having <code>wpa_supplicant</code> itself to connect my laptop to
        the network! So, it was important to do that through the USB before
        installing it (which comes with the program preinstalled), just
        by making sure to add it in the configuration file.</p>

        <p>Some other notes, if you can't reach the internet, don't
        add any DNS in <code>/etc/resolv.conf</code>. This should be
        done declaratively in <code>configuration.nix</code>.

        <p>In the end, I spent the entire afternoon playing around
        with it, taking breaks and what-not. I still haven't figured
        out why <code>nvim</code> was printing the literal escape
        character when going from normal to insert mode in the
        <code>xfce4-terminal</code> (and other actions also made it
        print this "garbage" to the console), why sometimes the network
        can reach the internet (and only some sites!) and sometimes not,
        and how to setup dualboot.</p>

        <p>But despite all of this, I think it was a worth installing
        it again. One sure sees things from a different perspective,
        and gets the chance to write another blog post!</p>

        <p>If there's something I overlooked or that could be done better,
        or maybe you can explain it differently, please be sure to
        <a href="https://lonamiwebs.github.io/contact">contact me</a>
        to let me know!</p>

        <p><a href="index">Back to the index</a></p>
    </div>
    </div>
</body>
</html>
