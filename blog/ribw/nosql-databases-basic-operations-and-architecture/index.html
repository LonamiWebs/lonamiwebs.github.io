<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="description" content="Official Lonami's website"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes"><title>Cassandra: Basic Operations and Architecture | Lonami's Blog</title><link rel="stylesheet" type="text/css" href="/style.css"> 
</head><body><nav><ul><li><a  href="/">lonami's&nbsp;site</a></li><li><a class=selected href="/blog">blog</a></li><li><a  href="/golb">golb</a></li></ul><div><a href="https://github.com/LonamiWebs"><img src="/img/github.svg" alt="github"></a><a href="/blog/atom.xml"><img src="/img/rss.svg" alt="rss"></a></div></nav><main><article><h1 class="title">Cassandra: Basic Operations and Architecture</h1><div class="time"><p>2020-03-05</p><p>last updated 2020-03-24</p></div><p>This is the second post in the NoSQL Databases series, with a brief description on the basic operations (such as insertion, retrieval, indexing…), and complete execution along with the data model / architecture.</p><p>Other posts in this series:</p><ul><li><a href="/blog/ribw/nosql-databases-an-introduction/">Cassandra: an Introduction</a></li><li><a href="/blog/ribw/nosql-databases-basic-operations-and-architecture/">Cassandra: Basic Operations and Architecture</a> (this post)</li></ul><hr><p>Cassandra uses it own Query Language for managing the databases, it is known as <strong>CQL </strong>(<strong>Cassandra Query Language</strong>). Cassandra stores data in <strong>_tables_</strong>, as in relational databases, and these tables are grouped in <strong>_keyspaces_</strong>. A keyspace defines a number of options that applies to all the tables it contains. The most used option is the <strong>replication strategy. </strong>It is recommended to have only one keyspace by application.</p><p>It is important to mention that <strong>tables and keyspaces</strong> are<strong> case insensitive</strong>, so myTable is equivalent to mytable, but it is possible to <strong>force case sensitivity</strong> using <strong>double-quotes</strong>.</p><p>To begin with the basic operations it is necessary to deploy Cassandra:</p><ol><li>Open a terminal in the root of the Apache Cassandra folder downloaded in the previous post.</li><li>Run the command:</li></ol><pre>$ bin/cassandra
</pre><p>Once Cassandra is deployed, it is time to open a<strong> CQL Shell</strong>, in <strong>other terminal</strong>, with the command:</p><pre>$ bin/cqlsh
</pre><p>It is possible to check if Cassandra is deployed if the SQL Shell prints the next message:</p><p>![](uwqQgQte-cuYb_pePFOuY58re23kngrDKNgL1qz4yOfnBDZkqMIH3fFuCrye.png) _CQL Shell_</p><h2 id="createinsert"><a href="#createinsert">Create/Insert</a></h2><h3 id="ddl-data-definition-language"><a href="#ddl-data-definition-language">DDL (Data Definition Language)</a></h3><h4 id="create-keyspace"><a href="#create-keyspace">Create keyspace</a></h4><p>A keyspace is created using a <strong>CREATE KEYSPACE </strong>statement:</p><pre>$ **CREATE** KEYSPACE [ **IF** **NOT** **EXISTS** ] keyspace_name **WITH** options;
</pre><p>The supported “<strong>options</strong>” are:</p><ul><li>“<strong>replication</strong>”: this is <strong>mandatory </strong>and defines the <strong>replication strategy</strong> and the <strong>replication factor</strong> (the number of nodes that will have a copy of the data). Within this option there is a property called “<strong>class</strong>” in which the <strong>replication strategy</strong> is specified (“SimpleStrategy” or “NetworkTopologyStrategy”)</li><li>“<strong>durable_writes</strong>”: this is <strong>not mandatory</strong> and it is possible to use the <strong>commit logs for updates</strong>. Attempting to create an already existing keyspace will return an error unless the <strong>IF NOT EXISTS </strong>directive is used.</li></ul><p>The example associated to this statement is create a keyspace with name “test_keyspace” with “SimpleStrategy” as “class” of replication and a “replication_factor” of 3.</p><pre>**CREATE** KEYSPACE test_keyspace
    **WITH** **replication** = {'class': 'SimpleStrategy',
                        'replication_factor' : 3};
</pre><p>The <strong>USE </strong>statement allows to <strong>change</strong> the current <strong>keyspace</strong>. The syntax of this statement is very simple:</p><pre>**USE** keyspace_name;
</pre><p>![](RDWIG2RwvEevUFQv6TGFtGzRm4_9ERpxPf0feriflaj3alvWw3FEIAr_ZdF1.png) _USE statement_</p><p>It is also possible to get the metadata from a keyspace with the <strong>DESCRIBE </strong>statement.</p><pre>**DESCRIBE** KEYSPACES | KEYSPACE keyspace_name;
</pre><h4 id="create-table"><a href="#create-table">Create table</a></h4><p>Creating a new table uses the <strong>CREATE TABLE </strong>statement:</p><pre>**CREATE** **TABLE** [ **IF** **NOT** **EXISTS** ] table_name
    '('
        column_definition
        ( ',' column_definition )*
        [ ',' **PRIMARY** **KEY** '(' primary_key ')' ]
    ')' [ **WITH** table_options ];
</pre><p>With “column_definition” as: column_name cql_type [ STATIC ] [ PRIMARY KEY]; “primary_key” as: partition_key [ ‘,’ clustering_columns ]; and “table_options” as: COMPACT STORAGE [ AND table_options ] or CLUSTERING ORDER BY ‘(‘ clustering_order ‘)’ [ AND table_options ] or “options”.</p><p>Attempting to create an already existing table will return an error unless the <strong>IF NOT EXISTS</strong> directive is used.</p><p>The <strong>CQL types</strong> are described in the References section.</p><p>For example, we are going to create a table called “species_table” in the keyspace “test_keyspace” in which we will have a “species” text (as PRIMARY KEY), a “common_name” text, a “population” varint, a “average_size” int and a “sex” text. Besides, we are going to add a comment to the table: “Some species records”;</p><pre>**CREATE** **TABLE** species_table (
    species text **PRIMARY** **KEY**,
    common_name text,
    population varint,
    average_size **int**,
    sex text,
) **WITH** **comment**='Some species records';
</pre><p>It is also possible to get the metadata from a table with the <strong>DESCRIBE </strong>statement.</p><pre>**DESCRIBE** **TABLES** | **TABLE** [keyspace_name.]table_name;
</pre><h3 id="dml-data-manipulation-language"><a href="#dml-data-manipulation-language">DML (Data Manipulation Language)</a></h3><h4 id="insert-data"><a href="#insert-data">Insert data</a></h4><p>Inserting data for a row is done using an <strong>INSERT </strong>statement:</p><pre>**INSERT** **INTO** table_name ( names_values | json_clause )
                      [ **IF** **NOT** **EXISTS** ]
                      [ **USING** update_parameter ( **AND** update_parameter )* ];
</pre><p>Where “names_values” is: names VALUES tuple_literal; “json_clause” is: JSON string [ DEFAULT ( NULL | UNSET ) ]; and “update_parameter” is usually: TTL.</p><p>For example we are going to use both VALUES and JSON clauses to insert data in the table “species_table”. In the VALUES clause it is necessary to supply the list of columns, not as in the JSON clause that is optional.</p><p>Note: TTL (Time To Live) and Timestamp are metrics for expiring data, so, when the time set is passed, the operation is expired.</p><p>In the VALUES clause we are going to insert a new specie called “White monkey”, with an average size of 3, its common name is “Copito de nieve”, population 0 and sex “male”.</p><pre>**INSERT** **INTO** species_table (species, common_name, population, average_size, sex)
                **VALUES** ('White monkey', 'Copito de nieve', 0, 3, 'male');
</pre><p>In the JSON clause we are going to insert a new specie called “Cloned sheep”, with an average size of 1, its common name is “Dolly the sheep”, population 0 and sex “female”.</p><pre>**INSERT** **INTO** species_table JSON '{"species": "Cloned Sheep",
                              "common_name": "Dolly the Sheep",
                              "average_size":1,
                              "population":0,
                              "sex": "female"}';
</pre><p>Note: all updates for an <strong>INSERT </strong>are applied <strong>atomically </strong>and in <strong>isolation.</strong></p><h2 id="read"><a href="#read">Read</a></h2><p>Querying data from data is done using a <strong>SELECT </strong>statement:</p><pre>**SELECT** [ JSON | **DISTINCT** ] ( select_clause | '*' )
                      **FROM** table_name
                      [ **WHERE** where_clause ]
                      [ **GROUP** **BY** group_by_clause ]
                      [ **ORDER** **BY** ordering_clause ]
                      [ PER **PARTITION** **LIMIT** (**integer** | bind_marker) ]
                      [ **LIMIT** (**integer** | bind_marker) ]
                      [ ALLOW FILTERING ];
</pre><p>The <strong>CQL SELECT </strong>statement is very <strong>similar </strong>to the <strong>SQL SELECT </strong>statement due to the fact that both allows filtering (<strong>WHERE</strong>), grouping data (<strong>GROUP BY</strong>), ordering the data (<strong>ORDER BY</strong>) and limit the number of data (<strong>LIMIT</strong>). Besides, <strong>CQL offers </strong>a <strong>limit per partition </strong>and allow the <strong>filtering </strong>of <strong>data</strong>.</p><p>Note: as in SQL it it possible to set alias to the data with the statement <strong>AS.</strong></p><p>For example we are going to retrieve all the information about those values from the tables “species_table” which “sex” is “male”. Allow filtering is mandatory when there is a WHERE statement.</p><pre>**SELECT** * **FROM** species_table **WHERE** sex = 'male' ALLOW FILTERING;
</pre><p>![](s6GrKIGATvOSD7oGRNScUU5RnLN_-3X1JXvnVi_wDT_hrmPMZdnCdBI8DpIJ.png) _SELECT statement_</p><p>Furthermore, we are going to test the SELECT JSON statement. For this, we are going to retrieve only the species name with a population of 0.</p><pre>**SELECT** JSON species **FROM** species_table **WHERE** population = 0 ALLOW FILTERING;
</pre><p>![](Up_eHlqKQp2RI5XIbgPOvj1B5J3gLxz7v7EI0NDRgezQTipecdfDT6AQoso0.png) _SELECT JSON statement_</p><h2 id="update"><a href="#update">Update</a></h2><h3 id="ddl-data-definition-language"><a href="#ddl-data-definition-language">DDL (Data Definition Language)</a></h3><h4 id="alter-keyspace"><a href="#alter-keyspace">Alter keyspace</a></h4><p>The statement <strong>ALTER KEYSPACE </strong>allows to modify the options of a keyspace:</p><pre>**ALTER** KEYSPACE keyspace_name **WITH** options;
</pre><p>Note: the supported <strong>options </strong>are the same than for creating a keyspace, “<strong>replication</strong>” and “<strong>durable_writes</strong>”.</p><p>The example associated to this statement is to modify the keyspace with name “test_keyspace” and set a “replication_factor” of 4.</p><pre>**ALTER** KEYSPACE test_keyspace
    **WITH** **replication** = {'class': 'SimpleStrategy', 'replication_factor' : 4};
</pre><h4 id="alter-table"><a href="#alter-table">Alter table</a></h4><p>Altering an existing table uses the <strong>ALTER TABLE </strong>statement:</p><pre>**ALTER** **TABLE** table_name alter_table_instruction;
</pre><p>Where “alter_table_instruction” can be: ADD column_name cql_type ( ‘,’ column_name cql_type )<em>; or DROP column_name ( column_name )</em>; or WITH options</p><p>The example associated to this statement is to ADD a new column to the table “species_table”, called “extinct” with type “boolean”.</p><pre>**ALTER** **TABLE** species_table **ADD** extinct **boolean**;
</pre><p>Another example is to DROP the column called “sex” from the table “species_table”.</p><pre>**ALTER** **TABLE** species_table **DROP** sex;
</pre><p>Finally, alter the comment with the WITH clause and set the comment to “All species records”.</p><pre>**ALTER** **TABLE** species_table **WITH** **comment**='All species records';
</pre><p>These changes can be checked with the <strong>DESCRIBE </strong>statement:</p><pre>**DESCRIBE** **TABLE** species_table;
</pre><p>![](xebKPqkWkn97YVHpRVXZYWvRUfeRUyCH-vPDs67aFaEeU53YTRbDOFscOlAr.png) _DESCRIBE table_</p><h3 id="dml-data-manipulation-language"><a href="#dml-data-manipulation-language">DML (Data Manipulation Language)</a></h3><h4 id="update-data"><a href="#update-data">Update data</a></h4><p>Updating a row is done using an <strong>UPDATE </strong>statement:</p><pre>**UPDATE** table_name
[ **USING** update_parameter ( **AND** update_parameter )* ]
**SET** assignment ( ',' assignment )*
**WHERE** where_clause
[ **IF** ( **EXISTS** | condition ( **AND** condition )*) ];
</pre><p>Where the update_parameter is: ( TIMESTAMP | TTL) (integer | bind_marker)</p><p>It is important to mention that the <strong>WHERE </strong>clause is used to select the row to update and <strong>must </strong>include <strong> all columns</strong> composing the <strong>PRIMARY KEY.</strong></p><p>We are going to test this statement updating the column “extinct” to true to the column with name ‘White monkey’.</p><pre>**UPDATE** species_table **SET** extinct = **true** **WHERE** species='White monkey';
</pre><p>![](IcaCe6VEC5c0ZQIygz-CiclzFyt491u7xPMg2muJLR8grmqaiUzkoQsVCoHf.png) _SELECT statement_</p><h2 id="delete"><a href="#delete">Delete</a></h2><h3 id="ddl-data-definition-language"><a href="#ddl-data-definition-language">DDL (Data Definition Language)</a></h3><h4 id="drop-keyspace"><a href="#drop-keyspace">Drop keyspace</a></h4><p>Dropping a keyspace can be done using the <strong>DROP KEYSPACE </strong>statement:</p><pre>**DROP** KEYSPACE [ **IF** **EXISTS** ] keyspace_name;
</pre><p>For example, drop the keyspace called “test_keyspace_2” if it exists:</p><pre>**DROP** KEYSPACE **IF** **EXISTS** test_keyspace_2;
</pre><p>As this keyspace does not exists, this sentence will do nothing.</p><h4 id="drop-table"><a href="#drop-table">Drop table</a></h4><p>Dropping a table uses the <strong>DROP TABLE </strong>statement:</p><pre>**DROP** **TABLE** [ **IF** **EXISTS** ] table_name;
</pre><p>For example, drop the table called “species_2” if it exists:</p><pre>**DROP** **TABLE** **IF** **EXISTS** species_2;
</pre><p>As this table does not exists, this sentence will do nothing.</p><h4 id="truncate-table"><a href="#truncate-table">Truncate (table)</a></h4><p>A table can be truncated using the <strong>TRUNCATE </strong>statement:</p><pre>**TRUNCATE** [ **TABLE** ] table_name;
</pre><p>Do not execute this command now, because if you do it, you will need to insert the previous data again.</p><p>Note: as tables are the only object that can be truncated the keyword TABLE can be omitted.</p><p>![](FOkhfpxlWFQCzcdfeWxLTy7wx5inDv0xwVeVhE79Pqtk3yYzWsZJnz_SBhUi.png) _TRUNCATE statement_</p><h3 id="dml-data-manipulation-language"><a href="#dml-data-manipulation-language">DML (Data Manipulation Language)</a></h3><h4 id="delete-data"><a href="#delete-data">Delete data</a></h4><p>Deleting rows or parts of rows uses the <strong>DELETE </strong>statement:</p><pre>**DELETE** [ simple_selection ( ',' simple_selection ) ]
                      **FROM** table_name
                      [ **USING** update_parameter ( **AND** update_parameter )* ]
                      **WHERE** where_clause
                      [ **IF** ( **EXISTS** | condition ( **AND** condition )*) ]
</pre><p>Now we are going to delete the value of the column “average_size” from “Cloned Sheep”.</p><pre>**DELETE** average_size **FROM** species_table **WHERE** species = 'Cloned Sheep';
</pre><p>![](CyuQokVL5J9TAelq-WEWhNl6kFtbIYs0R1AeU5NX4EkG-YQI81mNHdnf2yWN.png) _DELETE value statement_</p><p>And we are going to delete the same row as mentioned before.</p><pre>**DELETE** **FROM** species_table **WHERE** species = 'Cloned Sheep';
</pre><p>![](jvQ5cXJ5GTVQ6giVhBEpPJmrJw-zwKKyB9nsTm5PRcGSTzkmh-WO4kTeuLpB.png) _DELETE row statement_</p><h2 id="batch"><a href="#batch">Batch</a></h2><p>Multiple <strong>INSERT</strong>, <strong>UPDATE </strong>and <strong>DELETE </strong>can be executed in a <strong>single statement</strong> by grouping them through a <strong>BATCH </strong>statement.</p><pre>**BEGIN** [ UNLOGGED | COUNTER ] BATCH
                            [ **USING** update_parameter ( **AND** update_parameter )* ]
                            modification_statement ( ';' modification_statement )*
                            APPLY BATCH;
</pre><p>Where modification_statement can be a insert_statement or an update_statement or a delete_statement.</p><ul><li><strong>UNLOGGED </strong>means that either all operations in a batch eventually complete or none will.</li><li><strong>COUNTER</strong> means that the updates are not idempotent, so each time we execute the updates in a batch, we will have different results. For example:</li></ul><pre>**BEGIN** BATCH
   **INSERT** **INTO** species_table (species, common_name, population, average_size, extinct)
                **VALUES** ('Blue Shark', 'Tiburillo', 30, 10, **false**);
   **INSERT** **INTO** species_table (species, common_name, population, average_size, extinct)
                **VALUES** ('Cloned sheep', 'Dolly the Sheep', 1, 1, **true**);
   **UPDATE** species_table **SET** population = 2 **WHERE** species='Cloned sheep';
   **DELETE** **FROM** species_table **WHERE** species =  'White monkey';
APPLY BATCH;
</pre><p>![](EL9Dac26o0FqkVoeAKmopEKQe0wWq-xYI14b9RzGxtUkFJA3i2eTiR6qkuuJ.png) _BATCH statement_</p><h2 id="index"><a href="#index">Index</a></h2><p>CQL support creating secondary indexes on tables, allowing queries on the table to use those indexes.</p><p><strong>Creating </strong>a secondary index on a table uses the <strong>CREATE INDEX </strong>statement:</p><pre>**CREATE** [ CUSTOM ] **INDEX** [ **IF** **NOT** **EXISTS** ] [ index_name ]
                                **ON** table_name '(' index_identifier ')'
                                [ **USING** string [ **WITH** OPTIONS = map_literal ] ];
</pre><p>For example we are going to create a index called “population_idx” that is related to the column “population” in the table “species_table”.</p><pre>**CREATE** **INDEX** population_idx **ON** species_table (population);
</pre><p><strong>Dropping </strong>a secondary index uses the <strong>DROP INDEX</strong> statement:</p><pre>**DROP** **INDEX** [ **IF** **EXISTS** ] index_name;
</pre><p>Now, we are going to drop the previous index:</p><pre>**DROP** **INDEX** **IF** **EXISTS** population_idx;
</pre><h2 id="references"><a href="#references">References</a></h2><ul><li><a href="https://cassandra.apache.org/doc/latest/cql/ddl.html">Cassandra CQL</a></li><li><a href="https://techdifferences.com/difference-between-ddl-and-dml-in-dbms.html">Differences between DML and DDL</a></li><li><a href="https://docs.datastax.com/en/dse/5.1/cql/cql/cql_reference/cqlReferenceTOC.html">Datastax CQL</a></li><li><a href="https://cassandra.apache.org/doc/latest/cql/types.html#grammar-token-cql-type">Cassandra CQL Types</a></li><li><a href="https://cassandra.apache.org/doc/latest/cql/indexes.html">Cassandra Index</a></li></ul></article></main><footer><p> Share your thoughts! —
<a href="mailto:totufals@hotmail.com"><img src="/img/mail.svg" alt="Mail"></a> </p><p class="abyss" onclick="egg()">Gaze into the abyss… Oh hi there!</p></footer><script>
      const egg = () => {
    const audio = document.createElement('audio')
    audio.src = 'https://oriath.net/Audio/Dialogue/NPC/ShaperCombat/SH25b.dialogue.ogg'
    audio.play()
}
    </script></body></html>